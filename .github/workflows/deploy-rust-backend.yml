name: Build and Deploy Rust Backend to Vercel

on:
  push:
    branches: [main]
    paths:
      - 'app/backend/backend-rust/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            app/backend/backend-rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('app/backend/backend-rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        working-directory: app/backend/backend-rust
        run: |
          # Pull environment info but don't let it override our build approach
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN || echo "Note: vercel pull completed (may have warnings)"

      - name: Build Project
        working-directory: app/backend/backend-rust
        env:
          CARGO_BUILD_JOBS: 1
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: "-C link-arg=-s"
        run: |
          # Build the single router binary
          cargo build --release --bin router

      - name: Prepare for Prebuilt Deployment
        working-directory: app/backend/backend-rust
        run: |
          # Verify the binary was built successfully
          if [ ! -f target/release/router ]; then
            echo "Error: router binary not found"
            exit 1
          fi
          
          echo "✓ Binary ready: $(ls -lh target/release/router | awk '{print $5}')"
          
          # Temporarily rename vercel.json to prevent vercel-rust from detecting .rs files
          # This is the ONLY way to prevent Vercel from trying to build
          mv vercel.json vercel.json.disabled
          echo "✓ Temporarily disabled vercel.json to prevent builds"
          
          # Create minimal vercel.json for deployment (no functions config)
          cat > vercel.json << 'EOF'
          {
            "rewrites": [
              {"source": "/api/(.*)", "destination": "/api/router"},
              {"source": "/health", "destination": "/api/router"},
              {"source": "/nft/(.*)", "destination": "/api/router"}
            ],
            "headers": [
              {
                "source": "/api/(.*)",
                "headers": [
                  {"key": "Access-Control-Allow-Origin", "value": "*"},
                  {"key": "Access-Control-Allow-Methods", "value": "GET, POST, OPTIONS"},
                  {"key": "Access-Control-Allow-Headers", "value": "Content-Type, Authorization"}
                ]
              },
              {
                "source": "/nft/(.*)",
                "headers": [
                  {"key": "Access-Control-Allow-Origin", "value": "*"},
                  {"key": "Access-Control-Allow-Methods", "value": "GET, POST, OPTIONS"},
                  {"key": "Access-Control-Allow-Headers", "value": "Content-Type, Authorization"}
                ]
              },
              {
                "source": "/health",
                "headers": [
                  {"key": "Access-Control-Allow-Origin", "value": "*"},
                  {"key": "Access-Control-Allow-Methods", "value": "GET, OPTIONS"},
                  {"key": "Access-Control-Allow-Headers", "value": "Content-Type"}
                ]
              }
            ]
          }
          EOF
          
          # Create Build Output API structure
          mkdir -p .vercel/output/functions/api/router.func
          cp target/release/router .vercel/output/functions/api/router.func/bootstrap
          chmod +x .vercel/output/functions/api/router.func/bootstrap
          
          cat > .vercel/output/functions/api/router.func/.vc-config.json << 'EOF'
          {
            "runtime": "provided.al2",
            "handler": "bootstrap",
            "launcherType": "bootstrap",
            "maxDuration": 30
          }
          EOF
          
          python3 << 'PYEOF'
import json
import os
os.makedirs('.vercel/output', exist_ok=True)
with open('.vercel/output/config.json', 'w') as f:
    json.dump({"version": 3}, f, indent=2)
PYEOF
          
          echo "✓ Build output structure created"

      - name: Deploy to Vercel
        working-directory: app/backend/backend-rust
        run: |
          # Deploy with --prebuilt flag (no functions config = no build attempt)
          vercel deploy --prebuilt --prod
          
          # Restore original vercel.json
          mv vercel.json.disabled vercel.json
          echo "✓ Restored vercel.json"

